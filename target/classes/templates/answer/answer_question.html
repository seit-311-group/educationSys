<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <title>答题系统</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- 引入bootstrap-->
    <link rel="stylesheet" href="/css/main.css"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/bootstrap-theme.min.css" />
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/bootstrap.min.js" type="application/javascript"></script>
    <!--引入vue2和elementui vue3目前不支持-->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"/>
</head>
<style type="text/css">
    * {
        padding: 0;
        margin: 0;
    }

    #main{
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background-color: white;
        margin:0 auto;
        background-color: white;
        border-radius: 0px;
        box-shadow: #242424 0px 2px 5px;
        position: relative;
        height: 676px;
        width: 1544px;
        font-size: 16px;
    }

    #left_area{
        height: 676px;
        width: 80px;

    }

    #right_area{
        height: 676px;
        width: 1464px;
    }

    .btn-default{
        text-align: center;
        height: 30px;
        line-height: 0px;
    }
    .text{
        text-align:center;
        padding:0px 0px;
        width:100px;
    }
    #main_area{
        height: 590px;
        margin-top: 20px;
        position: relative;
        display: flex;

    }

    #nav_tabs{
        position: absolute;
        top: 0px;
        left: 93px;
    }

    #qa_area{
        display: flex;
        justify-content: center;
        position: absolute;
        top: 42px;
        left: 81px;
    }

    #question_area{
        width: 665px;
        height: 580px;
        border: 1px solid #dddddd;
    }

    #submit_place{
        display: flex;
        justify-content: center;
        position: relative;
        top: 15px;
        left: 15px;
        width: 634px;
    }

    #comment_place{
        display: flex;
        justify-content: center;
        position: relative;
        top: 15px;
        left: 15px;
        width: 634px;
    }

    #submit_table{
        font-size: 15px;
        border-radius: 0px;
        box-shadow: #d7d3d3 0px 2px 10px;
    }

    .nav_a{
        font-size: 13px;
    }


    #answer_area{
        display: flex;
        justify-content: center;
        flex-direction: column;
        position: relative;
        left: 10px;
        width: 776px;
        height: 580px;
        border: 1px solid #dddddd;
    }

    #answer_place_show{
        width: 776px;
        height: 580px;
    }

    /* 答题记录窗   */
    #control_show{
        border-top: 1px solid #dddddd;
        height: 150px;
        width: 776px;
    }

    #control_area{
        margin: 20px;
    }

    #finish{
        margin-left: 245px;
    }

    #question_result{
        margin-top: -30px;
    }

    .el-result__icon svg {
        width: 54px;
        height: 54px;
    }

    #error{
        height: 150px;
    }

    /*表格的颜色*/
    .el-table .warning-row {
        background: oldlace;
    }


    #answer_show{
        width: 776px;
    }

    .el-scrollbar__wrap {
        overflow-x: hidden;
    }
    #bar_left{
        display: flex;
        justify-content: left;
        margin-top: 4px;
        width: 690px;
        height: 40px;
        position:relative;
        margin-left: 65px;
    }

    #back_button{
        margin-top: -5px;
    }

    #np{
        display: flex;
        position: absolute;
        right: 31px;
    }

    #btn_previous{
        margin-top: -5px;
    }

    #btn_next{
        margin-top: -5px;
    }

    #function_area{
        display: flex;
        justify-content: center;
        position: absolute;
        top: 631px;
        left: 22px;

    }

    #bar_right{
        display: flex;
        margin-left: -20px;
        width: 865px;
        height: 40px;
        /*border: 1px solid black;*/
    }

    #how_to_use{
        position: absolute;
        margin-top: 470px;
        margin-left: 30px;
    }

    /* icon的大小   */
    .icon-size{
        font-size: 23px;
    }

    .icon-color{
        color: white;
    }

    .click{
        cursor: pointer;
    }

    .nav_a{
        cursor: pointer;
    }

    #label_area{
        width: 81px;
        height: 81px;
        background-color: #005825;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #label{
        font-family: "Helvetica Neue";
        font-size: 25px;
        color: white;
    }

    #label_bar{
        position: absolute;
        width: 81px;
        height: 596px;
        background-color: black;
    }

    #question_empty .el-empty__image{
        display: none;
    }

    .el-table__body-wrapper .is-scrolling-none{
        height: 60px;
    }


</style>
<style>
    body {
        color: #000;
        margin: 0;
        padding: 0;
    }
    img {
        border: 0;
    }
    input {
        border-bottom: 1px solid #000;
        border-top: 0px;
        border-left: 0px;
        border-right: 0px;
    }
    /* 利用穿透，设置input边框 */
    .inputDeep input.el-input__inner:focus {
        border-color: #2b542c;
    }
</style>


<body style="background-color: #efefef">
<div th:include="navigation :: nav"></div>
<div id="main">
    <div id="main_area">
        <div id="left_area">
            <div id="label_area"><span id="label">AN</span></div>
            <div id="label_bar">
                <div id="how_to_use" class="icon-size icon-color click">
                    <i class="el-icon-question" @click="dialogVisible = true"></i>
                    <el-dialog
                            title="答题系统介绍"
                            :visible.sync="dialogVisible"
                            width="55%"
                            :before-close="handleClose">
                            <span>这是一个电路计算题的做题系统，你可以选择你想要做的题目，现在主要有以下功能：<br/>
                                1. 你可以在问答框中输入问题，系统会<strong>自动匹配</strong>你的问题，通过点击来选择你要的问题。<br/>
                                2. 如果没有你的问题，我们后台会有记录，并且会尽快完善！<br/>
                                3. 支持<strong>联想子问题</strong>功能.<br/>
                                4. 你还可以点击右上角<strong>上传图片</strong>上传一个图片来描述你的问题，我们收到问题后，会将答案发回给你哦~<br/>
                                系统还有很多功能没有上线呢！谢谢大家的配合，我们会根据大家的意见或者建议尽快完善系统！</span>
                        <span slot="footer" class="dialog-footer">
                        <el-button type="primary" @click="dialogVisible = false">确 定</el-button>
                            </span>
                    </el-dialog>
                </div>

            </div>

        </div>
        <div id="right_area">
            <div id="head">
                <div id="nav_tabs">
                    <ul class="nav nav-tabs">
                        <li  role="presentation" :class="question_active"><a class="nav_a" id="question_bar" v-on:click="show_question" style="font-size: 15px; color: black">
                            <span class="glyphicon glyphicon-tasks" aria-hidden="true" ></span>
                            题目描述</a></li>
                        <!--<li role="presentation" :class="comment_active"><a class="nav_a" id="comment_bar" v-on:click="show_comment" style="font-size: 15px; color: black">-->
                        <!--    <span class="glyphicon glyphicon-comment" aria-hidden="true"></span>-->
                        <!--    评论</a></li>-->
                        <li role="presentation" :class="submit_active"><a class="nav_a" id="submit_bar" v-on:click="show_submit" style="font-size: 15px; color: black">
                            <span class="glyphicon glyphicon-record" aria-hidden="true"></span>
                            提交记录</a></li>
                    </ul>
                </div>
            </div>
            <div id="qa_area">
                <div id="question_area">
                    <el-scrollbar ref="questionScrollbar" style="height:100%; width: 100%">
                        <div id="question_place" :style="{'display': question_place_show}"></div>
                        <div id="comment_place" :style="{'display': comment_place_show}">
                            <el-empty description="该题还没任何评论" :style="{'display': commentEmpty}"></el-empty>

                        </div>
                        <div id="submit_place" :style="{'display': submit_place_show}">
                            <el-empty description="您还没任何提交记录" :style="{'display': submitRecordEmpty}"></el-empty>
                            <table id="submit_table"  align="center" style="text-align: center" class="table table-striped table-bordered" :style="{'display': submitRecord}">
                                <thead>
                                <tr>
                                    <td style="width: 350px">做题结果</td>
                                    <td style="width: 100px" >花费时间</td>
                                    <td style="width: 181px">提交时间</td>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="record in records">
                                    <td>
                                        <ul class="dropdown">
                                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                                               aria-expanded="false" >
                                                <span :style="{'color': setResultColor(record.result)}" style="font-size: 15px">{{record.result}}</span>
                                            </a>
                                            <ul class="dropdown-menu" >
                                                <strong><li v-html="record.point" style="white-space: pre-wrap; font-size: 15px"></li></strong>
                                            </ul>
                                        </ul>
                                    </td>
                                    <td>{{record.timespend}}</td>
                                    <td>{{record.timesubmit}}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </el-scrollbar>

                </div>

                <div id="answer_area">
                    <div id="answer_place_show">
                        <el-scrollbar ref="answerScrollbar" style="height:100%; width: 100%" >
                            <div id="answer_show">
                            </div>
                        </el-scrollbar>
                    </div>

                    <div id="control_show" :style="{'display': icon_up_show}">
                        <div id="control_area">
                            <div id="question_empty" :style="{'display': question_empty}">
                                <el-empty description="该题还没任何答题记录,请先作答"></el-empty>
                            </div>
                            <div id="finish" :style="{'display': question_finish}">
                                <span style="font-size: 18px; color: #2b542c; font-weight: bold;">恭喜你，你已经完全掌握本题！</span>
                                <div id="question_result">
                                    <el-result icon="success"></el-result>
                                </div>
                            </div>
                            <div id="error" :style="{'display': question_error}">
                                <el-scrollbar ref="errorScrollbar" style="height:100%; width: 100%">
                                    <el-table
                                            height="150px"
                                            :data="tableData"
                                            style="width: 715px; font-size: 15px; margin-left: 40px; margin-top: -15px;"
                                            :cell-style="{'text-align':'center'}"
                                            :row-class-name="tableRowClassName">
                                        <el-table-column
                                                prop="error_points"
                                                label="你对以下知识点的掌握还不够："
                                                width="650px"
                                                align='center'>
                                        </el-table-column>
                                    </el-table>
                                </el-scrollbar>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
            <div id="function_area">
                <div id="bar_left">
                    <div id="btn_list">
                        <div id="back_button">
                            <el-button type="info" onclick="window.location.href='/answer_index'" icon="el-icon-menu">返回题目列表</el-button>
                        </div>


                    </div>
                    <div id="np">
                        <div id="btn_previous">
                            <el-button type="info" icon="el-icon-back" v-on:click="previous_question" :class="{'disabled': pdisabled}">上一题</el-button>
                        </div>
                        <span style="font-size: 14px; margin-top: 6px;">&nbsp;&nbsp;&nbsp;&nbsp;{{now_questions}}/{{all_questions}}&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <div id="btn_next">
                            <el-button type="info" icon="el-icon-right" v-on:click="next_question" :class="{'disabled' : ndisabled}">下一题</el-button>
                        </div>

                    </div>
                </div>
                <div id="bar_right">
                    <el-button type="text" style="font-size: 15px; color: black; margin: auto; margin-left: 20px;"
                               @click="iconChange" v-model="control_active"
                    >&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp答题记录&nbsp&nbsp
                        <div class="el-icon-arrow-down" :style="{'display': icon_down_show}"></div>
                        <div class="el-icon-arrow-up" :style="{'display': icon_up_show}"></div>
                    </el-button>
                    <el-button type="primary" style="margin-right: 87px"
                               @click="do_it_again"
                    >再做一遍</el-button>
                </div>
            </div>
        </div>


    </div>

</div>




</body>
<script>
    // <![CDATA[
    var vm = new Vue({
        el: '#main',
        data() {
            return {
                now_questions: '',
                all_questions: '',
                pdisabled: false,
                ndisabled: false,
                question_place_show: '',
                comment_place_show: 'none',
                submit_place_show: 'none',
                question_active: 'active',
                icon_down_show: 'inline',
                icon_up_show: 'none',
                comment_active: '',
                submit_active: '',
                records: {},
                errorPointsList: '',
                domain: '',
                functionInput: '',
                dialogVisible: false, // 如何使用按钮
                submitRecord: 'none',   // 提交是否为空
                submitRecordEmpty: 'none',
                commentEmpty: 'inline',   // 评论是否为空

                // 答题记录
                control_active: false,
                question_time: 0,
                all_pass: true,
                question_empty: 'none',
                question_finish: 'none',
                question_error: 'inline',
                // 错误知识点的表格
                tableData: []

            }
        },
        mounted: function (){
            this.load();
        },
        methods: {
            async load(){
                var temp = window.location.href;
                this.domain = temp.split(':')[1].substring(2);
                var x1 = temp.length; //地址的总长度
                var x2 = temp.indexOf("="); //取得=号的位置
                this.now_questions = temp.substr(x2 + 1, x1 - x2 - 1);//截取id为题号
                await axios.get('/answer/question',{        //执行完await的方法才会往后执行
                }).then(response=>{
                    this.all_questions = response.data;
                })
                if(this.now_questions == 1){
                    this.pdisabled = true;
                }else if(this.now_questions == this.all_questions){
                    this.ndisabled = true;
                }else{
                    this.pdisabled = false;
                    this.ndisabled = false;
                }

            },
            previous_question() {
                if(this.pdisabled == true){
                    return;
                }
                let index =  Number(this.now_questions) - 1;
                window.location.href = 'http://'+this.domain+':8080/question?id=' + index;

            },
            next_question() {
                if(this.ndisabled == true){
                    return;
                }
                let index = Number(this.now_questions) + 1;
                window.location.href = 'http://'+this.domain+':8080/question?id=' + index;

            },
            show_question(){
                this.question_place_show = '';
                this.comment_place_show = 'none';
                this.submit_place_show = 'none';
                this.question_active = 'active';
                this.comment_active = '';
                this.submit_active = '';
            },
            show_comment() {
                this.question_place_show = 'none';
                this.comment_place_show = '';
                this.submit_place_show = 'none';
                this.question_active = '';
                this.comment_active = 'active';
                this.submit_active = '';
                var question_place = document.getElementById("question_place");

            },
            show_submit() {
                this.question_place_show = 'none';
                this.comment_place_show = 'none';
                this.submit_place_show = '';
                this.question_active = '';
                this.comment_active = '';
                this.submit_active = 'active';

                this.loadRecords();
            },
            async loadRecords(){
                let questionRecords = {};
                await axios.post('answerRecords/showAllRecords',{
                    questionid: this.now_questions
                }).then(response=>{
                    questionRecords = response.data;
                })
                var key = 'point';
                for (var record of questionRecords){
                    if(record.result == ''|| record.result == ' ' || record.result == null){
                        record.result = '通过';
                        record[key] = '无';
                    }else{
                        let value = '';
                        await this.loadpoints(record.result).then(res =>{
                            value = res;
                        });
                        record[key] = value;
                        record.result = '解答错误（点击查看错误的知识点）';
                    }
                    record.timespend = this.calTime(record.timespend);

                }
                this.records = questionRecords;
                if (this.records.length == 0){
                    this.submitRecordEmpty = 'inline';
                }else{
                    this.submitRecord = 'inline';
                }
            },
            setResultColor(result){
                if(result == '通过'){
                    return 'green';
                }else{
                    return 'red';
                }
            },
            calTime(second){
                return Math.ceil(second/60) + '分钟';
            },
            async loadpoints(result){
                let res = '';
                await axios.post('answerRecords/getAllPoints',{
                    pointId: result
                }).then(response1=>{
                    res = response1.data;
                })
                return res;
            },
            iconChange(){
                if (this.control_active == false){
                    this.icon_down_show = 'none';
                    this.icon_up_show = 'inline';
                    this.control_active = true;
                    var answer_place_show = document.getElementById('answer_place_show');
                    answer_place_show.style.height = '430px'
                }else{
                    this.icon_down_show = 'inline';
                    this.icon_up_show = 'none';
                    this.control_active = false;
                    var answer_place_show = document.getElementById('answer_place_show');
                    answer_place_show.style.height = '580px'
                }
                // this.$refs['myScrollbar'].wrap.scrollTop = this.$refs['myScrollbar'].wrap.scrollHeight
            },
            // 滚动条置底
            scrollDown(ref) {
                this.$refs[ref].wrap.scrollTop = this.$refs[ref].wrap.scrollHeight
            },
            handleClose(done) {     // 如何使用的弹窗
                done();
            },
            // 做完题目答题记录弹出
            finishQuestion(){
                this.icon_down_show = 'none';
                this.icon_up_show = 'inline';
                this.control_active = true;
                var answer_place_show = document.getElementById('answer_place_show');
                answer_place_show.style.height = '430px';
                if (this.all_pass == true){
                    this.question_empty = 'none';
                    this.question_finish = 'inline';
                    this.question_error = 'none';

                }else{
                    this.question_empty = 'none';
                    this.question_finish = 'none';
                    this.question_error = 'inline';
                }
            },
            do_it_again(){
                document.location.reload();

            },
            // 弹出错误
            wrong(message) {
                this.$notify.error({
                    title: '错误',
                    message: message,
                    offset: 100
                });
            },
            // 弹出成功
            right(message) {
                this.$notify({
                    title: '成功',
                    message: message,
                    type: 'success',
                    offset: 100
                });
            },
            tableRowClassName(){
                return 'warning-row';
            },
            async matchFunction(function1, function2){
                var res;
                await axios.post('/solution/matchFunction',{
                    function1: function1,
                    function2: function2,
                }).then(response=>{
                    res = response.data;
                })
                return res;
            }

        }
    })

    // ]]>
</script>
<script type="text/javascript">
    // <![CDATA[

    let url = window.location.href; //获取当前页面的url
    var n1 = url.length; //地址的总长度
    var n2 = url.indexOf("="); //取得=号的位置
    var questionid = decodeURI(url.substr(n2 + 1, n1 - n2 - 1));//截取id为题号
    let domain = url.split(':')[1].substring(2);


    let count = 0;
    let urlMap = new Map();
    urlMap.set("1","网孔法");
    urlMap.set("2","节点法");
    urlMap.set("3","叠加原理");
    urlMap.set("4","戴维南");//Temp1
    urlMap.set("5","戴维南1");//Temp2
    urlMap.set("6","电容");
    urlMap.set("7","电感");
    urlMap.set("8","一阶RC");
    urlMap.set("9","一阶RL");
    urlMap.set("10","交流节点法");//Temp3
    urlMap.set("11","交流网孔法");
    urlMap.set("12","电源变换");


    let questionName = urlMap.get(questionid);
    let subquesIDarr = null;
    let pointarr = null;
    let answer = null;
    let answerID = null;
    let map = new Map();//选项内容和知识点的kv对
    let errorOption = new Set();
    let addpicture = null;//是否需要增加图片
    let changepicture = null;//是否需要更换图片
    let errorPoints = ''; // 错误的知识点
    let subqueIndex = 0;
    let second = 0;
    var count1 = null;



    window.onload = function() {
        ajax({
            url: "/solution/getDescriptionBYId?id=" + questionid,       // 得到题目的描述
            success: function (res) {
                load(res);
            }
        })
        ajax({
            url:"/solution/getSubquesIDsBYId?id=" + questionid,         // 得到子问题的ID
            success: function(res) {
                let subquesID = res;
                subquesIDarr = subquesID.split(",");
            }
        })
        ajax({
            url:"/solution/getPointIDsBYId?id=" + questionid,           //得到知识点的ID
            success: function(res) {
                let pointIDs = res;
                pointarr = pointIDs.split(",");
            }
        })
        ajax({
            url:"/solution/getAddPictureByID?id=" + questionid,         // 是否需要增加图片
            success: function(res) {
                if (res.length > 0) {
                    addpicture = res.split(",");
                    console.log(res);
                }
            }
        })
        ajax({
            url:"/solution/getChangePictureByID?id=" + questionid,      // 是否要切换题目的图片
            success: function(res) {
                if (res.length > 0) {
                    changepicture = res.split(",");
                }
            }
        })
    };

    // 把电路图和题目显示在问题区
    function load(res) {
        let newbr = document.createElement('br');   //换行
        let question = document.createElement('div');
        let img = document.createElement('img');
        img.src = questionName + '/picture1.png';
        img.id = 'img';

        question.id = 'question';
        question.className = 'question';
        question.innerHTML = '&nbsp&nbsp'+ questionid + '.' + res;
        var question_place = document.getElementById("question_place");
        question_place.appendChild(question);
        question_place.appendChild(newbr);
        question_place.appendChild(img);

        // 首先开始答题的按钮要居中
        button();


    }
    //开始答题按钮并监听
    function button() {
        let answer_show = document.getElementById('answer_show');
        let process = document.createElement('div');
        let button = document.createElement('button');
        let strong = document.createElement('strong');

        process.className = 'process';
        process.id = 'process';
        button.id = 'sendbtn';
        button.className = 'btn btn-default';
        button.role = 'group';
        button.aria_label = '...';
        button.style.height = '60px'


        button.addEventListener("click",f);     // 事件监听器
        strong.innerHTML = '开始答题';
        strong.style.fontSize = '25px';
        button.appendChild(strong);

        process.appendChild(button);

        process.style.marginTop='250px';
        process.style.marginLeft='340px';

        answer_show.appendChild(process);
    }

    // 点击开始答题按钮发生
    function f(){
        // 把整个process回到原位
        let process = document.getElementById('process');
        process.style.marginTop='20px';
        process.style.marginLeft='60px';
        process.style.marginRight='10px';
        process.style.marginRight='20px';

        beginCount();       // 开始计时
        ajax({url:"/solution/getAnalysisBYId?id=" + questionid,     // 得到题目的分析
            success: function(res){
                chooseOrList(res);
            }
        })
    }
    function beginCount(){
        count1 = setInterval(countTime,1000);
    }
    function countTime(){
        second += 1;
    }

    //得到题目的分析并显示 对电路图进行分析和替换
    function analysis(res, list){
        let process = document.getElementById('process');
        let newbr = document.createElement('br');
        let newbr1 = document.createElement('br');
        let button = document.getElementById('div_choose');
        button.parentNode.replaceChild(newbr,button);   // 答题按钮换位空行
        process.innerHTML += res;
        process.appendChild(newbr1);

        // 新的按钮
        let newbutton = document.createElement('button');
        newbutton.id = 'sendbtn0';
        newbutton.type = 'button'
        newbutton.className = 'el-button el-button--primary'
        var span = document.createElement('span');
        span.innerHTML = "继续";
        newbutton.appendChild(span);
        newbutton.style.fontSize = '16px';
        newbutton.addEventListener("click", function () {
            equation(false, list);
        });
        process.appendChild(newbutton);

        let img = document.getElementById('img');
        let img1 = document.createElement('img');
        img1.src = questionName + '/picture2.png';
        img1.id = 'img';
        img.parentElement.replaceChild(img1, img);
    }


    // isList：代表学生是否在列方程 list表示学生最开始的时候选择的是列方程还是做选择
    function equation(isList, list) {
        // count = 0：说明是第一题 不弹出错误提示； check：做错返回false 才进入if；
        if((count > 0) && !check() && !isList){
            // alert("选择错误，请重新选择！");
            vm.wrong('选择错误，请重新选择！');
        } else{
            if (addpicture != null && addpicture.length != 0) {  //增加图片
                if (String(count) == addpicture[0]) {
                    addpicture.splice(0, 1);    // 从第一个开始删除一个元素 array.splice(index,howmany,item1,.....,itemX) howmany删除元素的个数
                    addPicture("part" + addpicture[0] + ".png")
                    addpicture.splice(0, 1);
                }
            }

            if (changepicture != null && changepicture.length != 0) {   // 改变图片
                if (String(count) == changepicture[0]) {
                    changepicture.splice(0, 1);
                    changePicture("part" + changepicture[0] + ".png")
                    changepicture.splice(0, 1);
                }
            }

            if (count < subquesIDarr.length) {
                let subquesid = subquesIDarr[count];
                // 判断这个题目能不能列方程 ajax根据subquestion的字段listEquation来判断
                var listEquation = true;
                ajax({
                    url: "/solution/isListEquation?subQuestionId=" + subquesid,
                    async:false,
                    success:function (res){
                        listEquation = res;
                        // 巨坑无比 ajax返回的变量时string 而不是boolean
                    }
                })
                if (list && (listEquation == 'true')){
                    // 如果可以列方程 先把题目显示出来
                    ajax({
                        url: "/solution/getContentBYSubquesId?id=" + subquesid,    // 得到子问题的题目 然后显示出来 count+1
                        success: function (res) {
                            subqueIndex++;
                            res = subqueIndex+'.' + res;
                            if (isList){    //如果上一题在列方程 就把上一题的disable掉 然后再创建子问题
                                disableInputAndCreate(res);
                            }else{
                                createSubquestion(res);
                            }
                            createListArea(subquesid);
                        }
                    });
                }else{
                    chooseTheEquationFull(subquesid);
                    // 通过这个按钮来做一个循环
                    newButtonChoose("提交", list);
                }
            } else {
                over(list);
            }
        }
    }

    function chooseOrList(res){
        let button = document.getElementById('sendbtn');
        let div = document.createElement('div');
        div.id = 'div_choose';
        div.style.display = 'flex';
        div.style.width = '453px';

        let div1 = document.createElement('div');
        div1.innerHTML = '你想做';
        div1.style.fontSize = '16px';
        div1.style.margin = 'auto';


        // 选择题按钮
        var button_choose = document.createElement('button');
        button_choose.id = 'button_choose' + count; // 给列方程的按钮一个id 后面把这个按钮删了
        button_choose.type = 'button'
        button_choose.className = 'el-button el-button--primary'
        var span_choose = document.createElement('span');
        span_choose.innerHTML = "选择题";
        button_choose.appendChild(span_choose);
        button_choose.style.fontSize = '16px';
        button_choose.addEventListener('click', function () {
            analysis(res, false);
        })
        let div2 = document.createElement('div');
        div2.innerHTML = '还是';
        div2.style.fontSize = '16px';
        div2.style.margin = 'auto';

        // 列方程按钮
        var button_list = document.createElement('button');
        button_list.id = 'button_list' + count; // 给列方程的按钮一个id 后面把这个按钮删了
        button_list.type = 'button'
        button_list.className = 'el-button el-button--primary'
        var span_list = document.createElement('span');
        span_list.innerHTML = "列方程";
        button_list.appendChild(span_list);
        button_list.style.fontSize = '16px';
        button_list.addEventListener('click', function () {
            analysis(res, true);
        })
        let div3 = document.createElement('div');
        div3.innerHTML = '（请点击选择）';
        div3.style.fontSize = '16px';
        div3.style.margin = 'auto';

        div.appendChild(div1);
        div.appendChild(button_choose);
        div.appendChild(div2);
        div.appendChild(button_list);
        div.appendChild(div3);

        button.parentNode.replaceChild(div,button);   // 开始答题按钮换选择按钮

        document.scrollingElement.scrollTop = document.scrollingElement.scrollHeight;
    }

    // 如果不可以列方程直接全部出现做选择题
    function chooseTheEquationFull(subquesid){
        ajax({
            url: "/solution/getContentBYSubquesId?id=" + subquesid,    // 得到子问题的题目 然后显示出来 count+1
            success: function (res) {
                subqueIndex++;
                res = subqueIndex+'.' + res;
                createSubquestion(res);
            }
        });
        ajax({
            url: "/solution/getAnswerBYSubquesId?id=" + subquesid,     // 得到子问题答案对应的答案id
            success: function (res) {
                answerID = res;
            }
        });
        ajax({
            url: "/solution/getOptionIDBYSubquesId?id=" + subquesid,       // 得到子问题的选项id
            success: function (res) {
                let options = res;
                if (res.length == 0) {
                    return;
                }
                let optionsArr = options.split(",");
                // 把选项遍历出来
                for (let i = 0; i < optionsArr.length; i++) {
                    let content = null;
                    let optionID = optionsArr[i];
                    let map1 = new Map();//选项ID和内容的kv对
                    ajax({
                        url: "/solution/getContentBYOptionId?id=" + optionID,  // 得到选项的内容
                        success: function (res) {
                            content = res;
                            map1.set(optionID, content);
                            if (optionID == answerID.toString()) {
                                answer = res;
                            }
                        }
                    });
                    ajax({
                        url:"/solution/getPointIDBYOptionID?id=" + optionID,   //得到知识点id
                        success: function(res) {
                            if(res == "") {
                                return;
                            }
                            let pointID = res;
                            ajax({
                                url: "/solution/getContentBYPointId?id=" + pointID,    // 根据知识点id等到知识点
                                success: function (res) {
                                    map.set(map1.get(optionID), res);   // 存放知识点id对应的知识点
                                }
                            });
                        }
                    })
                    if ((content.substr(content.length-4, 4) == ".png") || (content.substr(content.length-4, 4) == ".jpg")) {
                        createPicOption(content, 65 + i);
                    }
                    else {
                        createOption(content, 65 + i);//65是A对应的ASCII码   ABCD选项
                    }
                }
            }
        });
    }
    // 如果可以列方程 学生选择了做选择则直接出现选择题
    function chooseTheEquation(subquesid){
        ajax({
            url: "/solution/getContentBYSubquesId?id=" + subquesid,    // 得到子问题的题目 然后显示出来 count+1
            success: function (res) {
                subqueIndex++;
                res = subqueIndex+'.' + res;
                createSubquestion(res);
            }
        });
        ajax({
            url: "/solution/getAnswerBYSubquesId?id=" + subquesid,     // 得到子问题答案对应的答案id
            success: function (res) {
                answerID = res;
            }
        });
        ajax({
            url: "/solution/getOptionIDBYSubquesId?id=" + subquesid,       // 得到子问题的选项id
            success: function (res) {
                let options = res;
                if (res.length == 0) {
                    return;
                }
                let optionsArr = options.split(",");
                // 把选项遍历出来
                for (let i = 0; i < optionsArr.length; i++) {
                    let content = null;
                    let optionID = optionsArr[i];
                    let map1 = new Map();//选项ID和内容的kv对
                    ajax({
                        url: "/solution/getContentBYOptionId?id=" + optionID,  // 得到选项的内容
                        success: function (res) {
                            content = res;
                            map1.set(optionID, content);
                            if (optionID == answerID.toString()) {
                                answer = res;
                            }
                        }
                    });
                    ajax({
                        url:"/solution/getPointIDBYOptionID?id=" + optionID,   //得到知识点id
                        success: function(res) {
                            if(res == "") {
                                return;
                            }
                            let pointID = res;
                            ajax({
                                url: "/solution/getContentBYPointId?id=" + pointID,    // 根据知识点id等到知识点
                                success: function (res) {
                                    map.set(map1.get(optionID), res);   // 存放知识点id对应的知识点
                                }
                            });
                        }
                    })
                    if ((content.substr(content.length-4, 4) == ".png") || (content.substr(content.length-4, 4) == ".jpg")) {
                        createPicOption(content, 65 + i);
                    }
                    else {
                        createOption(content, 65 + i);//65是A对应的ASCII码   ABCD选项
                    }
                }
            }
        });
    }

    function addPicture(pic) {
        let question = document.getElementById('question');
        let img = document.createElement('img');
        let div = document.createElement('div');
        div.style.textAlign = 'center';
        img.src = questionName + '/' + pic;
        img.id = 'img';
        div.appendChild(img);

        question.appendChild(div);
    }
    function changePicture(pic) {
        let img = document.getElementById('img');
        let img1 = document.createElement('img');
        img1.src = questionName + '/' + pic;
        img1.id = 'img';
        img.parentElement.replaceChild(img1, img);
    }
    function createSubquestion(res){
        let process = document.getElementById('process');
        let newbr = document.createElement('br');
        let button = document.getElementById('sendbtn' + count);
        count += 1;
        let newdiv = document.createElement('div');
        newdiv.id = 'div' + count;
        button.parentNode.replaceChild(newbr,button);
        newdiv.innerHTML += res;
        process.appendChild(newdiv);
    }
    // 把input区disable掉 然后提交按钮删了 创建子问题
    function disableInputAndCreate(res){
        let div = document.getElementById('div_input' + count);
        div.className = 'el-input is-disabled';
        let input = document.getElementById('input' + count);
        input.disabled = 'disabled';
        let list_button = document.getElementById('list_button' + count);
        let list_area = document.getElementById('list_area' + count);
        list_area.removeChild(list_button);

        if(document.getElementById('check_button' + count) != null){
            list_area.removeChild(document.getElementById('check_button' + count));
        }

        //然后把子问题创建出来
        let process = document.getElementById('process');
        let newbr = document.createElement('br');
        count += 1;
        let newdiv = document.createElement('div');
        newdiv.id = 'div' + count;
        newdiv.innerHTML += res;
        process.appendChild(newbr);
        process.appendChild(newdiv);
    }
    function createOption(content, code){
        let newdiv = document.getElementById('div' + count);
        let div = document.createElement('div');
        let input = document.createElement('input');
        input.type = 'radio';
        input.name = 'option' + count; //选项名，每个小问题的几个选项的选项名相同，方便批改
        input.value = content;

        div.appendChild(input);
        div.innerHTML += String.fromCharCode(code) + ". " + content;
        newdiv.appendChild(div);
    }
    function createPicOption(content, code){
        let newdiv = document.getElementById('div' + count);
        let div = document.createElement('div');
        let input = document.createElement('input');
        let newbr = document.createElement('br');

        input.type = 'radio';
        input.name = 'option' + count;
        input.value = content;

        div.appendChild(input);
        div.innerHTML += String.fromCharCode(code) + ". ";
        div.appendChild(newbr);
        let picArr = content.split(",");
        for (let i of picArr) {
            let img = document.createElement('img');
            img.src = questionName + '/' + i;
            img.id = 'img';
            div.appendChild(img);
        }
        newdiv.appendChild(div);}

    function newButtonChoose(content, list){
        let newdiv = document.getElementById('div' + count);
        let newbutton = document.createElement('button');
        let newbr = document.createElement('br');
        newbutton.type = 'button'
        newbutton.className = 'el-button el-button--primary'
        var span = document.createElement('span');
        span.innerHTML = content;
        newbutton.appendChild(span);
        newbutton.style.fontSize = '16px';
        newbutton.id = 'sendbtn' + count;
        newbutton.addEventListener("click", function (){
            equation(false, list);
        });
        newdiv.appendChild(newbutton);
        vm.scrollDown('answerScrollbar');
    }

    // 整个列方程的区域 count 表示是哪题
    function createListArea(subquesid){
        // 用ajax获得正确的方程为 function1
        var function1 = ''
        ajax({
            url: "/solution/findRightFunction?subQuestionId=" + subquesid,
            success: function (res) {
                function1 = res;
            }
        })

        // 找到第几个div框
        let newdiv = document.getElementById('div' + count);
        let newbr = document.createElement('br');

        var list_area =  document.createElement('div');
        // list_area.style.height = '300px';
        // list_area.style.border = '1px solid black';
        list_area.id = 'list_area' + count;
        list_area.style.width = '500px';

        // 输入框
        var div = document.createElement('div');
        div.id = 'div_input' + count;       // 给输入div一个id 调整他的className
        div.className = 'el-input';
        div.style.width = '350px'
        var input = document.createElement('input');
        input.className = 'el-input__inner';
        input.id = 'input' + count;     // 给输入框一个id 后面disable掉
        input.type = 'text';
        input.placeholder = '请输入公式';
        input.style.fontSize = '16px';
        div.appendChild(input);
        // 提交按钮
        var button = document.createElement('button');
        button.id = 'list_button' + count; // 给列方程的按钮一个id 后面把这个按钮删了
        button.type = 'button'
        button.className = 'el-button el-button--primary'
        var span = document.createElement('span');
        span.innerHTML = "提交";
        button.appendChild(span);
        button.style.marginLeft = '30px';
        button.style.fontSize = '16px';
        button.addEventListener('click', function () {
            listSubmit(function1, count);
        })

        list_area.appendChild(div);
        list_area.appendChild(button);

        newdiv.appendChild(newbr);
        newdiv.appendChild(list_area);
        newdiv.scrollIntoView();
        document.scrollingElement.scrollTop = document.scrollingElement.scrollHeight;
    }

    // 不用async 在调用axios方法默认是异步的 所以必须要在调用axios方法的函数上再加上async和await
    async function listSubmit(function1, count) {
        var input = document.getElementById('input' + count);
        var function2 = input.value;
        if (function2.trim() == ''){
            vm.wrong("公式输入不能为空！");
            return;
        }
        var similarity = 0;
        // 看这里！！！！前端接收Json 前端发送Json 后端接收Json 后端发送Json！！！！！后端可以用list封装对象 vip这样做的
        await vm.matchFunction(function1, function2).then(res=>{
            similarity = res.similarity;
        });

        // ajax 调用后端接口 判断相似度1
        if(similarity == 1){
            input.style.color = '#2b542c';
            vm.right('恭喜你，你的方程已经列对了哦！');
            equation(true, true);
        }else{
            input.style.color = 'red';
            similarity = 1;
            vm.wrong('你的方程列错了哦，可以选择重新列，或者查看答案！');
            let list_area = document.getElementById('list_area' + count);
            // 查看答案按钮
            if(document.getElementById('check_button' + count) == null){
                var button = document.createElement('button');
                button.id = 'check_button' + count; // 给列方程的按钮一个id 后面把这个按钮删了
                button.type = 'button'
                button.className = 'el-button el-button--primary'
                var span = document.createElement('span');
                span.innerHTML = "查看答案";
                button.appendChild(span);
                button.style.margin = 'auto';
                button.style.fontSize = '16px';
                button.addEventListener('click', function () {
                    //查看答案 function1为正确答案
                    var answer = function1
                    input.value = answer;
                    input.style.color = 'red';
                    equation(true, true);
                })
                list_area.appendChild(button);
                vm.scrollDown('answerScrollbar')
            }

        }
    }

    // 检查是否做对！
    function check() {
        let obj = document.getElementsByName('option' + count);

        for(let i = 0; i < obj.length; i++){
            if(obj[i].checked){
                if(obj[i].value == answer){     // answer为答案的编号
                    return true;
                }else{
                    errorOption.add(obj[i].value);
                    return false;
                }
            }
        }
    }

    function over(list){
        clearInterval(count1);
        if(list){
            var answer = '';
            ajax({
                url: "/solution/getAnswerByID?id=" + questionid,
                success: function (res) {
                    answer = res;
                }
            });

            let div = document.getElementById('div_input' + count);
            div.className = 'el-input is-disabled';
            let input = document.getElementById('input' + count);
            input.disabled = 'disabled';
            let list_button = document.getElementById('list_button' + count);
            let list_area = document.getElementById('list_area' + count);
            list_area.removeChild(list_button);

            let process = document.getElementById('process');
            let newbr = document.createElement('br')
            let newdiv = document.createElement('div' + (count+1));
            newdiv.innerHTML += answer;
            process.appendChild(newbr);
            process.appendChild(newdiv);

            if(document.getElementById('check_button' + count) != null){
                list_area.removeChild(document.getElementById('check_button' + count));
            }
            // 把知识点搞进去就可以了
            for (let i = 0; i < 2; i++){

            }
            vm.finishQuestion();
            vm.scrollDown('answerScrollbar');
            vm.show_submit();
        }else{
            highLight();
            let process = document.getElementById('process');
            let newbr = document.createElement('br')
            let newdiv = document.createElement('div' + (count+1));
            let button = document.getElementById('sendbtn' + count);
            button.parentNode.replaceChild(newbr,button);

            ajax({
                url: "/solution/getAnswerByID?id=" + questionid,
                success: function (res) {
                    newdiv.innerHTML += res;
                }
            });

            if (errorOption.size == 0) {
                errorPoints = questionid + "@";
            } else{
                vm.all_pass = false;
                let index = 1;
                errorPoints += questionid + "@";
                let set = new Set();
                for (let i of errorOption) {
                    if (map.has(i)) {
                        errorPoints += map.get(i) + '@';
                        if (!set.has(map.get(i))){
                            set.add(map.get(i))
                            // 调用vue的实例
                            vm.tableData.push({'error_points': index + '.'+ map.get(i)});
                            index++;
                        }
                    } else {
                        continue;
                    }
                }
            }
            // 将做错的题目对应的知识点返回到后端
            // ajax不能传特殊字符到后端 所以要先对url进行编码在进行传输
            errorPoints += second;
            vm.question_time = second;
            ajax({
                url: "/student/saveErrorPoints?points=" + errorPoints,
            })
            // newdiv.appendChild(conclusion);
            process.appendChild(newdiv);
            // 调用vue实例的方法
            vm.finishQuestion();
            vm.scrollDown('answerScrollbar');
            vm.show_submit();
        }
    }

    // 把错误的选项标红
    function highLight(){
        let errorOptionsCount = questionid + '@';
        let countError = 0;
        let options = document.getElementsByTagName('input');
        for(let i = 0; i < options.length; i++){
            if(errorOption.has(options[i].value)) {
                options[i].parentElement.style.color = "red";
                countError++;
            }
        }
        errorOptionsCount += countError;
        ajax({
            url: "/answer/passRateUpdate?errorOptions=" + errorOptionsCount,
        })
    }
    function ajax(obj) {
        let xhr = null;
        if (window.ActiveXObject) {
            xhr = new ActiveXObject('Microsoft.XMLHTTP')
        } else {
            xhr = new XMLHttpRequest();
        }

        //打开与服务器的连接
        if (obj.method) {
            xhr.open(obj.method, obj.url, false);
        } else {
            xhr.open('get', obj.url, false);
        }
        xhr.setRequestHeader("Content-Type",
            "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Authorization",
            "APPCODE 3e9dfb924f464e9593a95f9d2bbf4348")

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                //数据接收完毕
                if (xhr.status == 200) {
                    //console.log('请求成功',xhr.responseText)
                    if (obj.success) {
                        obj.success(xhr.responseText)
                    }

                } else {
                    //console.log(xhr.status,'请求出错')
                    if (obj.failure) {
                        obj.failure('请求失败')
                    }
                }
            }
        }
        if (obj.method == undefined || obj.method.toLowerCase() == 'get') {
            xhr.send(null);
        } else {
            xhr.send(obj.params);
        }
    }

    // ]]>
</script>


</html>